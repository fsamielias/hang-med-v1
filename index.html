<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√§ng med App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            color: #2E2E2E;
        }
        .animate-fade-in-out {
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px) translateX(-50%); }
            10% { opacity: 1; transform: translateY(0) translateX(-50%); }
            90% { opacity: 1; transform: translateY(0) translateX(-50%); }
            100% { opacity: 0; transform: translateY(20px) translateX(-50%); }
        }
        /* Fix for iOS date/time input background color */
        input[type="date"], input[type="time"] {
            -webkit-appearance: none;
        }
        /* Hide scrollbar for filter bar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Animation for view transitions */
        @keyframes slideInFromRight {
            from { transform: translateX(50%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .view-container-animate {
            animation: slideInFromRight 0.25s ease-out;
        }
    </style>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'salviagron': '#8aa399',
                'ecru': '#F5F5DC',
              }
            }
          }
        }
    </script>
</head>
<body class="bg-white">
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // --- CONSTANTS & HELPER DATA (Moved outside component for efficiency) ---
        const { useState, useEffect, useRef, memo, useMemo, useCallback } = React;

        const USERS_DATA = [
            { userID: 1, name: 'Sofia', email: 'sofia@example.com' },
            { userID: 2, name: 'Erik', email: 'erik@example.com' },
            { userID: 5, name: 'Filip', email: 'filip@example.com' }
        ];

        const INITIAL_EVENTS_DATA = [
            { eventID: 104, title: 'Spontan √∂l p√• The Flying Barrel ikv√§ll?', description: 'N√•gon mer som √§r sugen p√• en fredags√∂l? T√§nkte dra in till stan. M√∂ts upp p√• The Flying Barrel runt kl 22. Inget komplicerat, bara trevligt h√§ng.', category: 'Ta ett glas', location: 'Kristinelundsgatan 3, G√∂teborg', dateTime: '2025-09-26T22:00:00', creatorUserID: 5, attendeeUserIDs: [5], isTimeFlexible: false },
            { eventID: 105, title: 'Svampplockning i V√§ttlefj√§ll', description: 'H√§ng med ut i skogen och leta svamp! V√§dret ser lovande ut. Vi m√∂ts vid Surtesj√∂n parkering och g√•r en runda i V√§ttlefj√§ll. Ta med korg och fika!', category: 'Promenad', location: 'V√§ttlefj√§lls naturreservat, Surte', dateTime: '2025-09-27T11:00:00', creatorUserID: 1, attendeeUserIDs: [1], isTimeFlexible: false },
            { eventID: 106, title: 'Br√§dspelskv√§ll n√§sta vecka?', description: '√Ñr det n√•gra som √§r sugna p√• en spelkv√§ll? T√§nkte Catan, Ticket to Ride eller n√•got liknande. Vi kan antingen vara hos n√•gon eller p√• ett spelcaf√©. Datum och plats kan vi best√§mma tillsammans i chatten!', category: 'Br√§dspel / Spelkv√§ll', location: 'Plats best√§ms i chatten', dateTime: '2025-10-03T00:00:00', creatorUserID: 2, attendeeUserIDs: [2], isTimeFlexible: true },
            { eventID: 101, title: 'Morgonfika p√• Espresso-House', description: 'En klassisk svensk fika f√∂r att starta dagen.', category: 'Fika', location: 'J√§rntorget 3, G√∂teborg', dateTime: '2025-09-27T10:00:00', creatorUserID: 2, attendeeUserIDs: [2, 5], isTimeFlexible: false },
            { eventID: 102, title: 'Avkopplande promenad i Slottsskogen', description: 'En fridfull promenad i vacker natur.', category: 'Promenad', location: 'S√§ldammsbacken, G√∂teborg', dateTime: '2025-09-28T14:30:00', creatorUserID: 1, attendeeUserIDs: [1, 5], isTimeFlexible: false },
            { eventID: 103, title: 'Badminton i Fj√§derborgen', description: 'V√§nskapsmatch i badminton, alla niv√•er v√§lkomna.', category: 'Sport', location: 'S√∂dra L√•ngebergsgatan 4, G√∂teborg', dateTime: '2025-09-29T18:00:00', creatorUserID: 1, attendeeUserIDs: [1], isTimeFlexible: false },
        ];

        const INITIAL_CHAT_MESSAGES_DATA = {
            101: [{ messageID: 1, userID: 2, text: "Ska bli s√• mysigt! Jag √§r d√§r prick kl 10.", timestamp: "2025-09-20T09:30:00" }, { messageID: 2, userID: 5, text: "Absolut, jag ser fram emot det!", timestamp: "2025-09-20T09:32:00" }],
            102: [{ messageID: 3, userID: 1, text: "Vilket h√§rligt v√§der det ser ut att bli!", timestamp: "2025-09-21T10:00:00" }]
        };

        const CATEGORY_MAP = {
            'Mat & Dryck': ['Fika', '√Ñta ute', 'Ta ett glas'],
            'Aktivitet & Natur': ['Promenad', 'Tr√§na tillsammans', 'Sport'],
            'Kultur & N√∂je': ['Bio', 'Museum / Utst√§llning', 'Konsert / Gig'],
            'Hobby & Spel': ['Br√§dspel / Spelkv√§ll', 'Fotografering'],
            'Id√© & F√∂rslag': ['Id√©/√ñppen f√∂r f√∂rslag'],
            'Annat': ['Annat']
        };

        // --- UTILITY FUNCTIONS ---
        const formatDateTime = (isoString, isTimeFlexible = false) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            
            if (isTimeFlexible) {
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                return `${date.toLocaleDateString('sv-SE', options)} (Flexibel tid)`;
            }

            const options = { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
            return date.toLocaleDateString('sv-SE', options);
        };
        
        const combineDateAndTime = (date, time) => {
            if (!date || !time) return null;
            return `${date}T${time}:00`;
        }

        // --- ICON COMPONENTS ---
        const Icons = {
            search: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>),
            home: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>),
            calendar: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>),
            user: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>),
            plus: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>),
            arrowLeft: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>),
            logOut: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>),
            users: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>),
            mapPin: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>),
            clock: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>),
            send: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>),
            messageCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>),
            settings: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>),
            chevronRight: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>),
            edit: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>),
            trash: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>),
        };
        
        // --- REUSABLE UI COMPONENTS ---
        const ActionButton = memo(({ onClick, children, className = '', type = "button" }) => (
            <button
                type={type}
                onClick={onClick}
                className={`w-full text-white font-bold py-3 px-4 rounded-full bg-salviagron hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-salviagron transition-transform active:scale-95 duration-150 shadow-sm ${className}`}
            >
                {children}
            </button>
        ));
        
        const Modal = ({ show, title, message, onClose, buttons }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 max-w-sm w-full mx-auto shadow-lg space-y-4">
                        {title && <h3 className="text-lg font-bold text-center text-[#2E2E2E]">{title}</h3>}
                        <p className="text-sm text-center text-slate-600">{message}</p>
                        <div className="flex justify-center space-x-4 mt-4">
                            {buttons.length > 0 ? (
                                buttons.map((button, index) => (
                                    <button
                                        key={index}
                                        onClick={() => {
                                            if (button.action) button.action();
                                            onClose();
                                        }}
                                        className={`py-2 px-4 rounded-full text-sm font-semibold transition-colors duration-150 ${
                                            button.primary ? 'bg-salviagron text-white hover:bg-salviagron/80' : 'bg-slate-200 text-slate-800 hover:bg-slate-300'
                                        }`}
                                    >
                                        {button.label}
                                    </button>
                                ))
                            ) : (
                                <button
                                    onClick={onClose}
                                    className="py-2 px-4 rounded-full text-sm font-semibold bg-salviagron text-white hover:bg-salviagron/80"
                                >
                                    OK
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        

        const BottomNav = memo(({ activeView, onNavigate }) => {
            const navItems = [
                { view: 'home', icon: Icons.home, label: 'Tr√§ffar' },
                { view: 'my-events', icon: Icons.calendar, label: 'Mina tr√§ffar' },
                { view: 'chat', icon: Icons.messageCircle, label: 'Chattar' },
                { view: 'profile', icon: Icons.user, label: 'Profil' }
            ];
            return (
                <div className="flex justify-around items-center p-2 bg-white/80 backdrop-blur-sm border-t border-slate-200/50 mt-auto">
                    {navItems.map(item => {
                        const isActive = activeView === item.view;
                        return (
                            <button
                                key={item.view}
                                onClick={() => onNavigate(item.view)}
                                className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-transform active:scale-95 duration-150 relative ${isActive ? 'text-salviagron' : 'text-black hover:text-salviagron'}`}
                            >
                                <item.icon className="w-6 h-6" />
                                <span className="text-xs font-bold">{item.label}</span>
                                {isActive && <div className="absolute -bottom-1 h-1 w-1 bg-salviagron rounded-full"></div>}
                            </button>
                        );
                    })}
                </div>
            );
        });

        const LoginScreen = memo(({ users, onLogin, onNavigate }) => {
            const [selectedUserId, setSelectedUserId] = useState(users[0]?.userID || '');
            const handleLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => u.userID === parseInt(selectedUserId));
                if (user) onLogin(user);
            };
            return (
                <div className="h-full flex flex-col justify-center items-center p-8 bg-white">
                    <h1 className="text-5xl font-bold mb-4 text-salviagron">H√§ng med</h1>
                    <p className="text-[#2E2E2E] mb-8 text-center">Uppt√§ck och skapa trevliga tr√§ffar n√§ra dig.</p>
                    <form onSubmit={handleLogin} className="w-full max-w-xs space-y-4">
                        <select value={selectedUserId} onChange={(e) => setSelectedUserId(e.target.value)} className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-salviagron bg-white">
                            {users.map(user => <option key={user.userID} value={user.userID}>{user.name}</option>)}
                        </select>
                        <ActionButton type="submit">Logga in</ActionButton>
                    </form>
                    <button onClick={() => onNavigate('signup')} className="text-sm text-[#2E2E2E] mt-4 hover:underline transition-transform active:scale-95 duration-150">Inget konto? Skapa ett</button>
                    <p className="text-xs text-slate-500 mt-8 text-center max-w-xs mx-auto">
                        Ett tips f√∂r en trygg tr√§ff: V√§lj en offentlig plats n√§r ni ses f√∂r f√∂rsta g√•ngen och anv√§nd sunt f√∂rnuft. Ha s√• kul!
                    </p>
                </div>
            );
        });

        const SignUpScreen = memo(({ onSignUp, onNavigate }) => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const handleSignUp = (e) => {
                e.preventDefault();
                if (name.trim() && email.trim()) onSignUp({ name, email });
            };
            return (
                <div className="h-full flex flex-col justify-center items-center p-8 bg-white">
                    <h1 className="text-4xl font-bold mb-4 text-salviagron">G√• med oss</h1>
                    <p className="text-[#2E2E2E] mb-8 text-center">Skapa ditt konto f√∂r att b√∂rja.</p>
                    <form onSubmit={handleSignUp} className="w-full max-w-xs space-y-4">
                        <div><input type="text" placeholder="Ditt namn" value={name} onChange={e => setName(e.target.value)} required className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" /></div>
                        <div><input type="email" placeholder="Din e-post" value={email} onChange={e => setEmail(e.target.value)} required className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" /></div>
                        <div><input type="password" placeholder="L√∂senord" required className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" /></div>
                        <ActionButton type="submit">Skapa konto</ActionButton>
                    </form>
                    <button onClick={() => onNavigate('login')} className="text-sm text-[#2E2E2E] mt-4 hover:underline transition-transform active:scale-95 duration-150">Har du redan ett konto? Logga in</button>
                </div>
            );
        });

        const HomeScreen = memo(({ events, onNavigate, currentUser }) => {
            const [activeFilter, setActiveFilter] = useState('Alla');
            const filters = ['Alla', 'Mina tr√§ffar', ...Object.keys(CATEGORY_MAP)];

            const filteredEvents = useMemo(() => {
                const sortedEvents = [...events].sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                if (activeFilter === 'Alla') {
                    return sortedEvents;
                }
                if (activeFilter === 'Mina tr√§ffar') {
                    // Den h√§r logiken matchar nu villkoret f√∂r att visa den gr√∂na pricken.
                    return sortedEvents.filter(event => 
                        event.attendeeUserIDs.includes(currentUser.userID)
                    );
                }
                const subCategories = CATEGORY_MAP[activeFilter];
                return sortedEvents.filter(event => subCategories.includes(event.category));
            }, [events, activeFilter, currentUser.userID]);
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                        <h1 className="text-3xl font-bold text-salviagron">Tr√§ffar</h1>
                        <p className="text-sm text-[#2E2E2E] mt-1">Hej {currentUser.name}, hitta eller skapa n√•got att g√∂ra!</p>
                    </header>
                    <div className="px-4 py-2 border-b border-slate-200/50 sticky top-[80px] bg-white/80 backdrop-blur-sm z-10">
                        <div className="flex space-x-2 overflow-x-auto pb-2 no-scrollbar">
                            {filters.map(filter => (
                                <button
                                    key={filter}
                                    onClick={() => setActiveFilter(prevFilter => prevFilter === filter ? 'Alla' : filter)}
                                    className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-colors transition-transform active:scale-95 duration-150 ${activeFilter === filter ? 'bg-salviagron text-white shadow-sm' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                >
                                    {filter}
                                </button>
                            ))}
                        </div>
                    </div>
                    <main className="flex-grow overflow-y-auto p-4 space-y-4">
                        {filteredEvents.map(event => {
                            const isJoined = event.attendeeUserIDs.includes(currentUser.userID);
                            const isCreator = event.creatorUserID === currentUser.userID;
                            return (
                                <div key={event.eventID} onClick={() => onNavigate('details', event.eventID)} className={`p-4 rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer bg-white relative`}>
                                    { isJoined &&
                                        <div className={`absolute bottom-3 right-3 h-4 w-4 rounded-full bg-salviagron ring-2 ${isCreator ? 'ring-ecru' : 'ring-white'}`}></div>
                                    }
                                    <div className="flex items-start gap-4">
                                        <div className="flex-1 min-w-0">
                                            <p className="font-bold text-[#2E2E2E] break-words">{event.title}</p>
                                            <p className="text-sm text-[#2E2E2E]">{event.category}</p>
                                            <div className="text-xs text-[#2E2E2E]/80 mt-2 flex items-center gap-2">
                                                <Icons.clock className="w-3 h-3" />
                                                <span className="font-bold">{formatDateTime(event.dateTime, event.isTimeFlexible)}</span>
                                            </div>
                                            <div className="text-xs text-[#2E2E2E]/80 mt-1 flex items-center gap-2">
                                                <Icons.mapPin className="w-3 h-3" />
                                                <span className="break-words">{event.location}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center text-sm text-blue-600 font-semibold">
                                            <Icons.users className="w-4 h-4 mr-1" />
                                            <span>{event.attendeeUserIDs.length}</span>
                                        </div>
                                    </div>
                                    
                                </div>
                            )
                        })}
                    </main>
                </div>
            );
        });
        
        const ChatComponent = memo(({ eventId, messages, usersById, currentUser, onSendMessage }) => {
            const [newMessage, setNewMessage] = useState('');
            const chatContainerRef = useRef(null);
            const inputRef = useRef(null);
            const formRef = useRef(null);

            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSend = (e) => {
                e.preventDefault();
                if (newMessage.trim()) {
                    onSendMessage(eventId, newMessage);
                    setNewMessage('');
                    inputRef.current?.focus();
                }
            };

            return (
                <div className="flex-grow flex flex-col overflow-hidden">
                    <div ref={chatContainerRef} className="flex-1 overflow-y-auto space-y-3 p-2 flex flex-col">
                        <div className="flex-grow"></div>
                        {messages.map(message => {
                            const sender = usersById[message.userID];
                            const isCurrentUser = sender.userID === currentUser.userID;
                            return (
                                <div key={message.messageID} className={`flex items-start gap-2 ${isCurrentUser ? 'justify-end' : 'justify-start'}`}>
                                    {!isCurrentUser && (
                                        <div className="w-8 h-8 rounded-full bg-ecru flex items-center justify-center font-bold text-[#2E2E2E]/70 text-sm flex-shrink-0">
                                            {sender.name.charAt(0)}
                                        </div>
                                    )}
                                    <div className={`flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}`}>
                                        {!isCurrentUser && (
                                            <span className="text-xs text-slate-500 mb-0.5 ml-3">{sender.name}</span>
                                        )}
                                        <div className={`max-w-xs p-3 rounded-2xl ${isCurrentUser ? 'bg-salviagron text-white rounded-br-none' : 'bg-slate-100 text-slate-800 rounded-bl-none'}`}>
                                            <p className="text-sm break-words">{message.text}</p>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        {messages.length === 0 && <p className="text-sm text-slate-400 text-center py-4">Inga meddelanden √§n. Bli den f√∂rsta att skriva!</p>}
                    </div>
                     <form ref={formRef} onSubmit={handleSend} className="p-2 flex-shrink-0 relative">
                        <textarea 
                            ref={inputRef}
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            placeholder="Skriv ett meddelande..."
                            className="w-full p-3 pr-14 border border-slate-200/80 rounded-xl focus:outline-none focus:ring-2 focus:ring-salviagron bg-white resize-none"
                            rows="2"
                        ></textarea>
                        <button type="submit" className="absolute top-3 right-3 p-2 rounded-full bg-salviagron text-white hover:opacity-90 transition-opacity">
                            <Icons.send className="w-5 h-5" />
                        </button>
                    </form>
                </div>
            );
        });
        
        const EventDetailsScreen = memo(({ eventId, events, usersById, currentUser, onJoin, onLeave, onNavigate, onBack, chatMessages, onSendMessage }) => {
            const event = events.find(e => e.eventID === eventId);
            if (!event) return <div className="p-4">Tr√§ffen hittades inte.</div>;
            
            const creator = usersById[event.creatorUserID];
            const attendees = event.attendeeUserIDs.map(id => usersById[id]);
            const hasJoined = event.attendeeUserIDs.includes(currentUser.userID);
            const isCreator = currentUser.userID === event.creatorUserID;
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 flex items-center justify-between border-b border-slate-200/50 bg-white/50 backdrop-blur-sm">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-100/60 transition-transform active:scale-95 duration-150">
                            <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <div className="flex-1"></div> {/* Spacer */}
                        
                    </header>
                    <main className="flex-grow overflow-y-auto p-4 space-y-4">
                        <div className={`bg-white p-4 rounded-xl space-y-3 shadow-lg`}>
                            <div className="flex items-center gap-4">
                                <div className="min-w-0"><h2 className="text-xl font-bold text-[#2E2E2E] break-words">{event.title}</h2></div>
                            </div>
                            <p className="text-[#2E2E2E]/80 break-words">{event.description}</p>
                            <div className="space-y-3 pt-2 text-[#2E2E2E]">
                                <div className="flex items-center gap-3">
                                    {event.isTimeFlexible ? (
                                        <><Icons.calendar className="w-5 h-5 text-salviagron" /><span className="font-semibold text-salviagron">{formatDateTime(event.dateTime, event.isTimeFlexible)}</span></>
                                    ) : (
                                        <><Icons.clock className="w-5 h-5 text-[#2E2E2E]/60" /><span>{formatDateTime(event.dateTime, event.isTimeFlexible)}</span></>
                                    )}
                                </div>
                                <div className="flex items-center gap-3"><Icons.mapPin className="w-5 h-5 text-[#2E2E2E]/60" /><span className="break-words min-w-0">{event.location}</span></div>
                                <div className="flex items-center gap-3"><Icons.user className="w-5 h-5 text-[#2E2E2E]/60" /><span>Skapad av <strong>{creator?.name || 'Ok√§nd'}</strong></span></div>
                            </div>
                            <div className="flex flex-wrap gap-2 pt-2">
                                {attendees.map(attendee => attendee && (
                                    <div key={attendee.userID} className={`flex items-center gap-2 pr-3 py-1 bg-slate-100 text-[#2E2E2E] rounded-full text-sm ${attendee.userID === currentUser.userID ? 'ring-2 ring-salviagron' : ''}`}>
                                        <div className="w-6 h-6 rounded-full bg-ecru flex items-center justify-center font-bold text-[#2E2E2E]/70 text-xs">
                                            {attendee.name.charAt(0)}
                                        </div>
                                        {attendee.name}
                                    </div>
                                ))}
                            </div>
                        </div>
                        {hasJoined && (
                             <button 
                                onClick={() => onNavigate('chat-detail', event.eventID)} 
                                className="w-full text-salviagron font-bold py-3 px-4 rounded-full bg-transparent border-2 border-salviagron hover:bg-salviagron/10 transition-colors duration-300 transition-transform active:scale-95"
                            >
                                Visa chatt
                            </button>
                        )}
                    </main>
                    <footer className="p-4 bg-white/80 backdrop-blur-sm border-t border-slate-200/50">
                        {isCreator && (
                            <ActionButton onClick={() => onNavigate('edit-event', event.eventID)} className="mb-2">
                                G√∂r √§ndringar i tr√§ff
                            </ActionButton>
                        )}
                        {hasJoined ? (
                            <button onClick={() => onLeave(event.eventID)} className="w-full text-red-700 font-semibold py-3 px-4 rounded-full bg-red-100 hover:bg-red-200 transition-all duration-300 shadow-sm transition-transform active:scale-95">
                                G√• ut fr√•n tr√§ff
                            </button>
                        ) : (
                             <ActionButton onClick={() => onJoin(event.eventID)} className="bg-green-500 hover:bg-green-600 focus:ring-green-500">
                                G√• med i tr√§ff
                            </ActionButton>
                        )}
                    </footer>
                </div>
            );
        });

        const CreateEventScreen = memo(({ currentUser, onProceed, onNavigate, onBack, initialData = {}, showModal }) => {
            const [title, setTitle] = useState(initialData.title || '');
            const [category, setCategory] = useState(initialData.category || 'Fika');
            const [location, setLocation] = useState(initialData.location || '');
            const [date, setDate] = useState(initialData.date || '');
            const [time, setTime] = useState(initialData.time || '');
            const [description, setDescription] = useState(initialData.description || '');
            const [isFlexibleTime, setIsFlexibleTime] = useState(initialData.isFlexibleTime || false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [locationSuggestions, setLocationSuggestions] = useState([]);
            const today = new Date().toISOString().split('T')[0];
            const isTimeOptional = isFlexibleTime;

            useEffect(() => {
                if (isFlexibleTime) {
                    setTime('');
                }
            }, [isFlexibleTime]);

            const GOTEBORG_LOCATIONS = [
                "√ñstra Hamngatan, G√∂teborg", "Kungsgatan, G√∂teborg", "Vasagatan, G√∂teborg",
                "S√∂dra V√§gen, G√∂teborg", "Drottningtorget, G√∂teborg", "Brunnsparsgatan, G√∂teborg",
                "Teatergatan, G√∂teborg", "Magasinsgatan, G√∂teborg", "Postgatan, G√∂teborg",
                "R√•dmansgatan, G√∂teborg", "Kyrkogatan, G√∂teborg", "Vallgatan, G√∂teborg",
                "Storgatan, G√∂teborg", "Engelbrektsgatan, G√∂teborg", "√ñvre Husargatan, G√∂teborg",
                "√ñstra Larmgatan, G√∂teborg", "Lilla Bommen, G√∂teborg", "Packhusplatsen, G√∂teborg",
                "Norra Hamngatan, G√∂teborg", "Kaserntorget, G√∂teborg", "Hedbergsgatan, G√∂teborg",
                "Kapellplatsen, G√∂teborg"
            ];

            const handleLocationChange = (e) => {
                const value = e.target.value;
                setLocation(value);
                if (value.length > 1) {
                    const suggestions = GOTEBORG_LOCATIONS.filter(loc => 
                        loc.toLowerCase().includes(value.toLowerCase())
                    );
                    setLocationSuggestions(suggestions);
                } else {
                    setLocationSuggestions([]);
                }
            };

            const selectSuggestion = (suggestion) => {
                setLocation(suggestion);
                setLocationSuggestions([]);
            };
            
            const generateAIDescription = () => {
                setIsGenerating(true);
                setTimeout(() => {
                    const timeOrFlex = isFlexibleTime ? 'en l√§mplig tid' : (time || 'utsatt tid');
                    const templates = {
                        'Fika': [`En trevlig fika f√∂r att snacka och umg√•s. Vi ses vid ${location || 'angiven plats'} runt ${timeOrFlex} f√∂r lite kaffe och gott s√§llskap.`, `Dags f√∂r en kaffepaus! Jag bjuder in till en avslappnad fika p√• ${location || 'trevligt st√§lle'} vid ${timeOrFlex}. Hoppas vi ses!`],
                        '√Ñta ute': [`Gemensam middag p√• ${location || 'restaurangen'}. En kv√§ll med god mat och h√§rligt s√§llskap. Bokat bord fr√•n kl ${timeOrFlex}.`, `Lunchdejt! Vi k√§kar p√• ${location || 'st√§llet'} runt ${timeOrFlex}. Ett perfekt avbrott i dagen.`],
                        'Ta ett glas': [`Sugen p√• en √∂l eller ett glas vin? Vi ses p√• ${location || 'ett trevligt st√§lle'} f√∂r en avslappnad after-work eller helgkv√§ll runt ${timeOrFlex}.`],
                        'Promenad': [`H√§ng med p√• en uppfriskande promenad vid ${location || 'v√•rt m√∂tesst√§lle'}. Vi tar en sk√∂n tur och njuter av omgivningen, startar runt ${timeOrFlex}.`],
                        'Tr√§na tillsammans': [`Dags att r√∂ra p√• sig! En l√∂prunda, ett pass p√• utegymmet eller n√•got annat? Vi ses vid ${location || 'platsen'} runt ${timeOrFlex} f√∂r att tr√§na tillsammans.`],
                        'Sport': [`Dags f√∂r sport! ${title || 'En rolig sportaktivitet'} vid ${location || 'platsen'}. Perfekt f√∂r att f√• upp pulsen och ha kul tillsammans. Starttid √§r ${timeOrFlex}.`, `Ska vi se matchen p√• ${location || 'en sportbar'}? Samling runt ${timeOrFlex}.`],
                        'Bio': [`Biokv√§ll! Vi ser "${title || 'den nya filmen'}" p√• ${location || 'biografen'}. Samling utanf√∂r en stund innan filmen b√∂rjar vid ${timeOrFlex}.`],
                        'Museum / Utst√§llning': [`Nyfiken p√• lite kultur? Vi g√•r p√• museum och kollar in ${title || 'en intressant utst√§llning'} p√• ${location || 'museet'}. Start runt ${timeOrFlex}.`],
                        'Konsert / Gig': [`Livemusik! Vi g√•r och ser ${title || 'ett grymt band'} p√• ${location || 'scenen'}. H√§ng p√• f√∂r en of√∂rgl√∂mlig kv√§ll! Starttid ${timeOrFlex}.`],
                        'Br√§dspel / Spelkv√§ll': [`Dags f√∂r spelkv√§ll! Vi samlas hemma hos mig eller p√• ${location || 'ett spelcaf√©'} f√∂r lite br√§dspel och trevligt umg√§nge. Start ${timeOrFlex}.`],
                        'Fotografering': [`Sugen p√• att fota? Vi tar en fotopromenad runt ${location || 'ett vackert omr√•de'} och f√•ngar dagen p√• bild. Vi b√∂rjar vid ${timeOrFlex}.`],
                        'Id√©/√ñppen f√∂r f√∂rslag': [`Ett f√∂rslag till tr√§ff: ${title || ''}. Vi kan ses vid ${location || 'utsatt plats'} runt ${date || 'angivet datum'}. Detaljer best√§mmer vi i chatten!`],
                        'Annat': [`En avslappnad tr√§ff: ${title || ''}. Vi tr√§ffas vid ${location || 'utsatt plats'} runt ${timeOrFlex}. Hoppas vi ses!`]
                    };
                    const categoryTemplates = templates[category] || templates['Annat'];
                    const randomIndex = Math.floor(Math.random() * categoryTemplates.length);
                    setDescription(categoryTemplates[randomIndex]);
                    setIsGenerating(false);
                }, 1000);
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                
                const timeProvided = !!time.trim();
                if (!date) {
                    showModal({
                        title: 'Datum saknas',
                        message: 'V√§nligen fyll i ett datum.',
                        buttons: [{ label: 'OK' }]
                    });
                    return;
                }

                if (!isFlexibleTime && !timeProvided) {
                    showModal({
                        title: 'Tid saknas',
                        message: 'V√§nligen fyll i en tid eller v√§lj "Flexibel tid".',
                        buttons: [{ label: 'OK' }]
                    });
                    return;
                }

                const finalTime = isFlexibleTime ? null : time;
                const dateTime = finalTime ? combineDateAndTime(date, finalTime) : `${date}T00:00:00`;

                const eventData = {
                    title, description, category, location, dateTime, 
                    isTimeFlexible: isFlexibleTime,
                    creatorUserID: currentUser.userID, attendeeUserIDs: [currentUser.userID],
                    // Pass form state for editing
                    formState: { title, category, location, date, time, isFlexibleTime, description } 
                };
                onProceed(eventData);
            };
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 flex items-center justify-between border-b border-slate-200/50 bg-white/50 backdrop-blur-sm sticky top-0">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-100/60 transition-transform active:scale-95 duration-150">
                             <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-xl font-semibold text-salviagron">Skapa ny tr√§ff</h1>
                        <div className="w-10"></div>
                    </header>
                    <main className="flex-grow overflow-y-auto p-4">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Titel</label>
                                <input type="text" value={title} onChange={e => setTitle(e.target.value)} required className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" maxLength="45" />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Kategori</label>
                                <select value={category} onChange={e => setCategory(e.target.value)} className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white">
                                    <optgroup label="‚òï Mat & Dryck">
                                        <option>Fika</option>
                                        <option>√Ñta ute</option>
                                        <option>Ta ett glas</option>
                                    </optgroup>
                                    <optgroup label="üå≥ Aktivitet & Natur">
                                        <option>Promenad</option>
                                        <option>Tr√§na tillsammans</option>
                                        <option>Sport</option>
                                    </optgroup>
                                    <optgroup label="üé≠ Kultur & N√∂je">
                                        <option>Bio</option>
                                        <option>Museum / Utst√§llning</option>
                                        <option>Konsert / Gig</option>
                                    </optgroup>
                                    <optgroup label="üé≤ Hobby & Spel">
                                        <option>Br√§dspel / Spelkv√§ll</option>
                                        <option>Fotografering</option>
                                    </optgroup>
                                    <optgroup label="üí° Id√© & F√∂rslag">
                                        <option>Id√©/√ñppen f√∂r f√∂rslag</option>
                                    </optgroup>
                                    <optgroup label="‚ú® Annat">
                                        <option>Annat</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Plats</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        value={location} 
                                        onChange={handleLocationChange} 
                                        required 
                                        className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" 
                                        maxLength="70" 
                                        autoComplete="off"
                                    />
                                    {locationSuggestions.length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg">
                                            {locationSuggestions.map((suggestion, index) => (
                                                <div 
                                                    key={index}
                                                    onClick={() => selectSuggestion(suggestion)}
                                                    className="p-2 hover:bg-slate-100 cursor-pointer"
                                                >
                                                    {suggestion}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Datum</label>
                                    <div className="relative mt-1">
                                        <input type="date" value={date} min={today} onChange={e => setDate(e.target.value)} required className="w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" />
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.calendar className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <div className="flex items-center justify-between">
                                        <label className="text-sm font-bold text-[#2E2E2E]">Tid</label>
                                        <div className="flex items-center text-sm font-semibold text-salviagron">
                                            <input type="checkbox" checked={isFlexibleTime} onChange={e => setIsFlexibleTime(e.target.checked)} id="flexible-time-create" className="mr-2 accent-salviagron" />
                                            <label htmlFor="flexible-time-create">Flexibel tid</label>
                                        </div>
                                    </div>
                                     <div className="relative mt-1">
                                        <input type="time" step="900" value={time} onChange={e => setTime(e.target.value)} disabled={isFlexibleTime} required={!isFlexibleTime} className={`w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white ${isFlexibleTime ? 'opacity-50 cursor-not-allowed' : ''}`} />
                                         <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.clock className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between items-center">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Beskrivning</label>
                                    <button type="button" onClick={generateAIDescription} disabled={isGenerating} className="text-sm text-salviagron hover:underline font-semibold disabled:opacity-50 transition-transform active:scale-95 duration-150">{isGenerating ? 'Genererar...' : 'Generera med AI'}</button>
                                </div>
                                <textarea value={description} onChange={e => setDescription(e.target.value)} required rows="4" className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" maxLength="280"></textarea>
                            </div>
                            <div className="pt-2"><ActionButton type="submit">Granska tr√§ff</ActionButton></div>
                        </form>
                    </main>
                </div>
            );
        });

        const ConfirmEventScreen = memo(({ eventData, onConfirm, onEdit, onBack }) => {
            if (!eventData) return null;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <header className="p-4 flex items-center justify-between border-b border-slate-200/50 bg-white/50 backdrop-blur-sm">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-100/60 transition-transform active:scale-95 duration-150">
                             <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-xl font-semibold text-salviagron">Bekr√§fta tr√§ff</h1>
                        <div className="w-10"></div>
                    </header>
                    <main className="flex-grow overflow-y-auto p-4 space-y-4">
                        <h2 className="text-lg font-semibold text-center text-[#2E2E2E]">Ser allt bra ut? </h2>
                        <div className="p-4 rounded-xl shadow-lg bg-white relative">
                            <div className="flex items-start gap-4">
                                <div className="flex-1 min-w-0">
                                    <p className="font-bold text-[#2E2E2E] break-words">{eventData.title}</p>
                                    <p className="text-sm text-[#2E2E2E]">{eventData.category}</p>
                                    <div className="text-xs text-[#2E2E2E]/80 mt-2 flex items-center gap-2">
                                        <Icons.clock className="w-3 h-3" />
                                        <span className="font-bold">{formatDateTime(eventData.dateTime, eventData.isTimeFlexible)}</span>
                                    </div>
                                    <div className="text-xs text-[#2E2E2E]/80 mt-1 flex items-center gap-2">
                                        <Icons.mapPin className="w-3 h-3" />
                                        <span className="break-words">{eventData.location}</span>
                                    </div>
                                    <p className="text-sm text-[#2E2E2E]/80 mt-3 pt-3 border-t border-slate-200/80 break-words">{eventData.description}</p>
                                </div>
                            </div>
                        </div>
                    </main>
                    <footer className="p-4 bg-white/80 backdrop-blur-sm border-t border-slate-200/50 space-y-2">
                         <ActionButton onClick={onConfirm}>Bekr√§fta & Skapa</ActionButton>
                         <button 
                            onClick={onEdit} 
                            className="w-full text-salviagron font-bold py-3 px-4 rounded-full bg-transparent border-2 border-salviagron hover:bg-salviagron/10 transition-colors duration-300 transition-transform active:scale-95"
                        >
                            Redigera
                        </button>
                    </footer>
                </div>
            );
        });
        
        const EditEventScreen = memo(({ eventId, events, onUpdate, onDelete, onNavigate, onBack, showModal }) => {
            const eventToEdit = useMemo(() => events.find(e => e.eventID === eventId), [events, eventId]);

            const [title, setTitle] = useState('');
            const [category, setCategory] = useState('Fika');
            const [location, setLocation] = useState('');
            const [date, setDate] = useState('');
            const [time, setTime] = useState('');
            const [description, setDescription] = useState('');
            const [isFlexibleTime, setIsFlexibleTime] = useState(false);
            const [isConfirmingDelete, setIsConfirmingDelete] = useState(false);
            
            useEffect(() => {
                if (eventToEdit) {
                    const eventDate = new Date(eventToEdit.dateTime);
                    setTitle(eventToEdit.title);
                    setCategory(eventToEdit.category);
                    setLocation(eventToEdit.location);
                    setDescription(eventToEdit.description);
                    // Use a more robust way to get date and time
                    const [datePart, timePart] = eventToEdit.dateTime.split('T');
                    setDate(datePart);
                    setIsFlexibleTime(eventToEdit.isTimeFlexible);
                    setTime(eventToEdit.isTimeFlexible ? '' : timePart.substring(0, 5));
                }
            }, [eventToEdit]);


            if (!eventToEdit) {
                return <div className="p-4">Kunde inte hitta tr√§ffen att redigera.</div>;
            }

            const handleSubmit = (e) => {
                e.preventDefault();
                
                const timeProvided = !!time.trim();
                if (!date) {
                    showModal({
                        title: 'Datum saknas',
                        message: 'V√§nligen fyll i ett datum.',
                        buttons: [{ label: 'OK' }]
                    });
                    return;
                }
                
                if (!isFlexibleTime && !timeProvided) {
                    showModal({
                        title: 'Tid saknas',
                        message: 'V√§nligen fyll i en tid eller v√§lj "Flexibel tid".',
                        buttons: [{ label: 'OK' }]
                    });
                    return;
                }

                const finalTime = isFlexibleTime ? null : time;
                const dateTime = finalTime ? combineDateAndTime(date, finalTime) : `${date}T00:00:00`;

                const updatedEvent = {
                    ...eventToEdit,
                    title, description, category, location, dateTime,
                    isTimeFlexible: isFlexibleTime
                };
                onUpdate(updatedEvent);
            };

            const handleDelete = () => {
                onDelete(eventId);
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 flex items-center justify-between border-b border-slate-200/50 bg-white/50 backdrop-blur-sm sticky top-0">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-100/60 transition-transform active:scale-95 duration-150">
                             <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-xl font-semibold text-salviagron">Redigera tr√§ff</h1>
                        <div className="w-10"></div>
                    </header>
                    <main className="flex-grow overflow-y-auto p-4">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Titel</label>
                                <input type="text" value={title} onChange={e => setTitle(e.target.value)} required className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" maxLength="45" />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Kategori</label>
                                <select value={category} onChange={e => setCategory(e.target.value)} className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white">
                                    <optgroup label="‚òï Mat & Dryck">
                                        <option>Fika</option>
                                        <option>√Ñta ute</option>
                                        <option>Ta ett glas</option>
                                    </optgroup>
                                    <optgroup label="üå≥ Aktivitet & Natur">
                                        <option>Promenad</option>
                                        <option>Tr√§na tillsammans</option>
                                        <option>Sport</option>
                                    </optgroup>
                                    <optgroup label="üé≠ Kultur & N√∂je">
                                        <option>Bio</option>
                                        <option>Museum / Utst√§llning</option>
                                        <option>Konsert / Gig</option>
                                    </optgroup>
                                    <optgroup label="üé≤ Hobby & Spel">
                                        <option>Br√§dspel / Spelkv√§ll</option>
                                        <option>Fotografering</option>
                                    </optgroup>
                                    <optgroup label="üí° Id√© & F√∂rslag">
                                        <option>Id√©/√ñppen f√∂r f√∂rslag</option>
                                    </optgroup>
                                    <optgroup label="‚ú® Annat">
                                        <option>Annat</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Plats</label>
                                <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} required className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" maxLength="70" />
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Datum</label>
                                    <div className="relative mt-1">
                                        <input type="date" value={date} min={new Date().toISOString().split('T')[0]} onChange={e => setDate(e.target.value)} required className="w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" />
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.calendar className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <div className="flex items-center justify-between">
                                        <label className="text-sm font-bold text-[#2E2E2E]">Tid</label>
                                        <div className="flex items-center text-sm font-semibold text-salviagron">
                                            <input type="checkbox" checked={isFlexibleTime} onChange={e => setIsFlexibleTime(e.target.checked)} id="flexible-time-edit" className="mr-2 accent-salviagron" />
                                            <label htmlFor="flexible-time-edit">Flexibel tid</label>
                                        </div>
                                    </div>
                                     <div className="relative mt-1">
                                        <input type="time" step="900" value={time} onChange={e => setTime(e.target.value)} disabled={isFlexibleTime} required={!isFlexibleTime} className={`w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white ${isFlexibleTime ? 'opacity-50 cursor-not-allowed' : ''}`} />
                                         <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.clock className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Beskrivning</label>
                                <textarea value={description} onChange={e => setDescription(e.target.value)} required rows="4" className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-salviagron bg-white" maxLength="280"></textarea>
                            </div>
                            <div className="pt-4 space-y-2">
                                <ActionButton type="submit">Spara √§ndringar</ActionButton>
                                {isConfirmingDelete ? (
                                    <div className="text-center p-4 rounded-lg bg-red-50">
                                        <p className="font-semibold text-red-700">√Ñr du s√§ker p√• att du vill ta bort tr√§ffen?</p>
                                        <p className="text-sm text-slate-500">Detta kan inte √•ngras.</p>
                                        <div className="mt-4 flex gap-4">
                                            <button onClick={() => setIsConfirmingDelete(false)} className="flex-1 text-slate-600 font-semibold py-2 px-4 rounded-full bg-slate-200 hover:bg-slate-300 transition-colors">Avbryt</button>
                                            <button onClick={handleDelete} className="flex-1 text-white font-semibold py-2 px-4 rounded-full bg-red-600 hover:bg-red-700 transition-colors">Ja, ta bort</button>
                                        </div>
                                    </div>
                                ) : (
                                     <button onClick={() => setIsConfirmingDelete(true)} className="w-full text-red-600 font-semibold py-3 px-4 rounded-full bg-red-100 hover:bg-red-200 transition-colors flex items-center justify-center gap-2">
                                        <Icons.trash className="w-5 h-5" />
                                        <span>Ta bort tr√§ff</span>
                                    </button>
                                )}
                            </div>
                        </form>
                    </main>
                </div>
            );
        });

        const MyEventsScreen = memo(({ events, currentUser, onNavigate }) => {
            
            const categorizedEvents = useMemo(() => {
                const now = new Date();
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);

                const upcomingJoined = [];
                const pastJoined = [];
                const createdEvents = [];

                events.forEach(event => {
                    const isAttending = event.attendeeUserIDs.includes(currentUser.userID);
                    if (!isAttending) return;

                    const eventDate = new Date(event.dateTime);
                    const isCreator = event.creatorUserID === currentUser.userID;

                    let isPast = false;
                    if (!event.dateTime) {
                        isPast = true;
                    } else if (event.isTimeFlexible) {
                        const eventDateStart = new Date(eventDate);
                        eventDateStart.setHours(0, 0, 0, 0);
                        isPast = eventDateStart < todayStart;
                    } else {
                        isPast = eventDate < now;
                    }

                    if (isPast) {
                        pastJoined.push(event);
                    } else {
                        if (isCreator) {
                            createdEvents.push(event);
                        } else {
                            upcomingJoined.push(event);
                        }
                    }
                });
                
                upcomingJoined.sort((a, b) => {
                    if (!a.dateTime) return 1; if (!b.dateTime) return -1;
                    return new Date(a.dateTime) - new Date(b.dateTime)
                });
                pastJoined.sort((a, b) => {
                    if (!a.dateTime) return 1; if (!b.dateTime) return -1;
                    return new Date(b.dateTime) - new Date(a.dateTime)
                });
                createdEvents.sort((a, b) => {
                    if (!a.dateTime) return 1; if (!b.dateTime) return -1;
                    return new Date(a.dateTime) - new Date(b.dateTime)
                });
                
                return { upcomingJoined, pastJoined, createdEvents };

            }, [events, currentUser.userID]);


            const EventCard = memo(({event, onNavigate, currentUser}) => {
                const isJoined = event.attendeeUserIDs.includes(currentUser.userID);
                const isCreator = event.creatorUserID === currentUser.userID;
                
                return (
                     <div onClick={() => onNavigate('details', event.eventID)} className={`p-4 rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer bg-white relative`}>
                        { isJoined &&
                            <div className={`absolute bottom-3 right-3 h-4 w-4 rounded-full bg-salviagron ring-2 ${isCreator ? 'ring-ecru' : 'ring-white'}`}></div>
                        }
                        <div className="flex items-start gap-4">
                            <div className="flex-1 min-w-0">
                                <p className="font-bold text-[#2E2E2E] break-words">{event.title}</p>
                                <p className="text-sm text-gray-600">{event.category}</p>
                                <div className="text-xs text-gray-500 mt-2 flex items-center gap-2">
                                    <Icons.clock className="w-3 h-3" />
                                    <span className="font-bold">{formatDateTime(event.dateTime, event.isTimeFlexible)}</span>
                                </div>
                                <div className="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                    <Icons.mapPin className="w-3 h-3" />
                                    <span className="break-words">{event.location}</span>
                                </div>
                            </div>
                            <div className="flex items-center text-sm text-blue-600 font-semibold">
                                <Icons.users className="w-4 h-4 mr-1" />
                                <span>{event.attendeeUserIDs.length}</span>
                            </div>
                        </div>
                        
                    </div>
                );
            });
            
            const EmptyState = ({icon, title, text}) => (
                <div className="text-center py-12">
                    <div className="w-16 h-16 mx-auto bg-slate-100 rounded-full flex items-center justify-center">{React.createElement(icon, { className: "w-8 h-8 text-slate-400" })}</div>
                    <h3 className="mt-4 text-lg font-semibold text-[#2E2E2E]">{title}</h3>
                    <p className="mt-1 text-sm text-[#2E2E2E]/70">{text}</p>
                </div>
            );
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10"><h1 className="text-3xl font-bold text-salviagron">Mina tr√§ffar</h1></header>
                    <main className="flex-grow overflow-y-auto p-4 space-y-6">
                         <div>
                            <h2 className="text-lg font-bold text-[#2E2E2E] text-center mb-3 underline">P√• g√•ng f√∂r mig ({categorizedEvents.upcomingJoined.length})</h2>
                            {categorizedEvents.upcomingJoined.length > 0 ? (
                                <div className="space-y-4">{categorizedEvents.upcomingJoined.map(event => (<EventCard key={event.eventID} event={event} onNavigate={onNavigate} currentUser={currentUser} />))}</div>
                            ) : (<EmptyState icon={Icons.calendar} title="Inga kommande tr√§ffar" text="G√• med i en tr√§ff f√∂r att se den h√§r." />)}
                        </div>
                         <div>
                            <h2 className="text-lg font-bold text-[#2E2E2E] text-center mb-3 underline">Mina skapade tr√§ffar ({categorizedEvents.createdEvents.length})</h2>
                            {categorizedEvents.createdEvents.length > 0 ? (
                                <div className="space-y-4">{categorizedEvents.createdEvents.map(event => (<EventCard key={event.eventID} event={event} onNavigate={onNavigate} currentUser={currentUser} />))}</div>
                            ) : (<EmptyState icon={Icons.plus} title="Du har inte skapat n√•got" text="Klicka p√• plus-knappen f√∂r att skapa din f√∂rsta tr√§ff." />)}
                        </div>
                         {categorizedEvents.pastJoined.length > 0 && (
                            <div>
                                <h2 className="text-lg font-bold text-[#2E2E2E] text-center mb-3 underline">Tidigare tr√§ffar ({categorizedEvents.pastJoined.length})</h2>
                                <div className="space-y-4 opacity-60">
                                    {categorizedEvents.pastJoined.map(event => (<EventCard key={event.eventID} event={event} onNavigate={onNavigate} currentUser={currentUser} />))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        });

        const ProfileScreen = memo(({ currentUser, onLogout, events, onNavigate }) => {
            const stats = useMemo(() => {
                return events.reduce((acc, event) => {
                    if (event.creatorUserID === currentUser.userID) {
                        acc.createdCount++;
                    }
                    if (event.attendeeUserIDs.includes(currentUser.userID) && event.creatorUserID !== currentUser.userID) {
                        acc.attendedCount++;
                    }
                    return acc;
                }, { createdCount: 0, attendedCount: 0});
            }, [events, currentUser.userID]);


            const SettingItem = ({ icon, label, onClick }) => (
                 <button onClick={onClick} className="w-full flex items-center justify-between text-left p-4 bg-white rounded-lg hover:bg-slate-100/60 transition-colors border border-slate-200/60">
                    <div className="flex items-center gap-4">
                        {React.createElement(icon, { className: "w-6 h-6 text-salviagron" })}
                        <span className="font-semibold text-[#2E2E2E]">{label}</span>
                    </div>
                    <Icons.chevronRight className="w-5 h-5 text-slate-400" />
                </button>
            );

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <header className="p-4 bg-white border-b border-slate-200/50">
                        <h1 className="text-3xl font-bold text-salviagron">Profil</h1>
                    </header>
                    <main className="flex-grow overflow-y-auto p-4 space-y-6">
                        <section className="flex flex-col items-center text-center space-y-2">
                             <div className="w-24 h-24 rounded-full bg-ecru flex items-center justify-center text-4xl font-bold text-[#2E2E2E] ring-4 ring-white/50 shadow-sm">{currentUser.name.charAt(0)}</div>
                             <h2 className="text-2xl font-bold text-[#2E2E2E] pt-2">{currentUser.name}</h2>
                             <p className="text-[#2E2E2E]/80">{currentUser.email}</p>
                        </section>

                        <section className="grid grid-cols-2 gap-4 text-center">
                            <div className="bg-white p-4 rounded-lg border border-slate-200/60">
                                <p className="text-2xl font-bold text-salviagron">{stats.createdCount}</p>
                                <p className="text-sm text-[#2E2E2E]/80">skapade</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg border border-slate-200/60">
                                <p className="text-2xl font-bold text-salviagron">{stats.attendedCount}</p>
                                <p className="text-sm text-[#2E2E2E]/80">deltagna</p>
                            </div>
                        </section>

                        <section className="space-y-3">
                            <h3 className="px-1 text-sm font-semibold text-slate-500 uppercase tracking-wider">Inst√§llningar</h3>
                            <div className="space-y-2">
                                <SettingItem icon={Icons.calendar} label="Min eventhistorik" onClick={() => onNavigate('event-history')} />
                                <SettingItem icon={Icons.user} label="Redigera profil" onClick={() => {}} />
                                <SettingItem icon={Icons.settings} label="Inst√§llningar" onClick={() => {}} />
                            </div>
                        </section>
                        
                        <section>
                             <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-red-600 bg-white rounded-lg hover:bg-red-50 transition-colors border border-slate-200/60">
                                <Icons.logOut className="w-5 h-5" />
                                <span>Logga ut</span>
                            </button>
                        </section>
                    </main>
                </div>
            )
        });

        const EventHistoryScreen = memo(({ events, currentUser, usersById, onNavigate, onBack }) => {
            const historyStats = useMemo(() => {
                const now = new Date();
                const pastAttendedEvents = events.filter(e => 
                    new Date(e.dateTime) < now && 
                    e.attendeeUserIDs.includes(currentUser.userID)
                );

                if (pastAttendedEvents.length === 0) {
                    return { pastAttendedEvents, total: 0, topCategory: 'Ingen √§n', topCompanion: 'Ingen √§n' };
                }

                const categoryCounts = pastAttendedEvents.reduce((acc, event) => {
                    acc[event.category] = (acc[event.category] || 0) + 1;
                    return acc;
                }, {});

                const topCategory = Object.keys(categoryCounts).reduce((a, b) => categoryCounts[a] > categoryCounts[b] ? a : b);

                const companionCounts = pastAttendedEvents
                    .flatMap(event => event.attendeeUserIDs)
                    .filter(id => id !== currentUser.userID)
                    .reduce((acc, id) => {
                        acc[id] = (acc[id] || 0) + 1;
                        return acc;
                    }, {});

                const topCompanionId = Object.keys(companionCounts).reduce((a, b) => companionCounts[a] > companionCounts[b] ? a : b, null);
                const topCompanion = topCompanionId ? usersById[topCompanionId]?.name : 'Ingen √§n';

                return {
                    pastAttendedEvents: pastAttendedEvents.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)),
                    total: pastAttendedEvents.length,
                    topCategory,
                    topCompanion
                };
            }, [events, currentUser.userID, usersById]);

            const StatCard = ({ label, value }) => (
                <div className="bg-white p-4 rounded-lg border border-slate-200/60 text-center">
                    <p className="text-sm text-[#2E2E2E]/80">{label}</p>
                    <p className="text-xl font-bold text-salviagron">{value}</p>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <header className="p-4 flex items-center gap-4 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-100/60">
                            <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-xl font-semibold text-salviagron">Min Eventhistorik</h1>
                    </header>
                    <main className="flex-grow overflow-y-auto p-4 space-y-6">
                        <section>
                            <h2 className="text-lg font-bold text-[#2E2E2E] mb-3">Din resa hittills</h2>
                            <div className="grid grid-cols-3 gap-4">
                                <StatCard label="Tr√§ffar" value={historyStats.total} />
                                <StatCard label="Favorit" value={historyStats.topCategory} />
                                <StatCard label="B√§stis" value={historyStats.topCompanion} />
                            </div>
                        </section>
                        
                        <section>
                             <h2 className="text-lg font-bold text-[#2E2E2E] mb-3">Tidslinje</h2>
                             {historyStats.pastAttendedEvents.length > 0 ? (
                                 <div className="space-y-3">
                                     {historyStats.pastAttendedEvents.map(event => (
                                         <div key={event.eventID} className="bg-white p-3 rounded-lg border border-slate-200/60 flex items-center gap-4">
                                             <div className="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
                                                 <Icons.calendar className="w-5 h-5 text-slate-500" />
                                             </div>
                                             <div>
                                                 <p className="font-semibold text-[#2E2E2E]">{event.title}</p>
                                                 <p className="text-sm text-slate-500">{formatDateTime(event.dateTime)}</p>
                                             </div>
                                         </div>
                                     ))}
                                 </div>
                             ) : (
                                 <div className="text-center py-10">
                                     <p className="text-slate-500">Du har inte deltagit i n√•gra tr√§ffar √§n.</p>
                                 </div>
                             )}
                        </section>
                    </main>
                </div>
            );
        });

        const Toast = ({ message, show }) => {
            if (!show) return null;
            return (<div className="fixed bottom-24 left-1/2 -translate-x-1/2 bg-[#3D3D3D] text-white px-4 py-2 rounded-full text-sm shadow-lg animate-fade-in-out">{message}</div>);
        };

        const ChatListScreen = memo(({ events, currentUser, onNavigate, usersById }) => {
            const { createdChats, attendingChats } = useMemo(() => {
                const joinedEvents = events
                    .filter(e => e.attendeeUserIDs.includes(currentUser.userID))
                    .sort((a,b) => {
                        if (!a.dateTime) return 1;
                        if (!b.dateTime) return -1;
                        return new Date(a.dateTime) - new Date(b.dateTime);
                    });
                
                const created = joinedEvents.filter(e => e.creatorUserID === currentUser.userID);
                const attending = joinedEvents.filter(e => e.creatorUserID !== currentUser.userID);
                
                return { createdChats: created, attendingChats: attending };
            }, [events, currentUser.userID]);


            const ChatEventCard = ({ event }) => {
                const isJoined = event.attendeeUserIDs.includes(currentUser.userID);
                const isCreator = event.creatorUserID === currentUser.userID;
                return (
                    <div onClick={() => onNavigate('chat-detail', event.eventID)} className={`bg-white rounded-lg shadow-lg transition-all cursor-pointer hover:bg-slate-50`}>
                        <div className="p-4 relative">
                            { isJoined &&
                                <div className={`absolute bottom-3 right-3 h-4 w-4 rounded-full bg-salviagron ring-2 ${isCreator ? 'ring-ecru' : 'ring-white'}`}></div>
                            }
                            <div className="flex items-start gap-4">
                                <div className="flex-1 min-w-0">
                                    <p className="font-bold text-[#2E2E2E] break-words">{event.title}</p>
                                    <p className="text-sm text-[#2E2E2E]">{event.category}</p>
                                    <div className="text-xs text-[#2E2E2E]/80 mt-2 flex items-center gap-2">
                                        <Icons.clock className="w-3 h-3" />
                                        <span className="font-bold">{formatDateTime(event.dateTime, event.isTimeFlexible)}</span>
                                    </div>
                                    <div className="text-xs text-[#2E2E2E]/80 mt-1 flex items-center gap-2">
                                        <Icons.mapPin className="w-3 h-3" />
                                        <span className="break-words">{event.location}</span>
                                    </div>
                                </div>
                                <div className="flex items-center text-sm text-blue-600 font-semibold">
                                    <Icons.users className="w-4 h-4 mr-1" />
                                    <span>{event.attendeeUserIDs.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const EmptyState = ({title, text}) => (
                <div className="text-center py-8">
                    <p className="text-slate-500 font-semibold">{title}</p>
                    <p className="text-sm text-slate-400 mt-1">{text}</p>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                        <h1 className="text-3xl font-bold text-salviagron">Chattar</h1>
                    </header>
                    <main className="flex-grow overflow-y-auto p-4 space-y-6">
                        <div>
                            <h2 className="text-lg font-bold text-[#2E2E2E] text-center mb-3 underline">P√• g√•ng f√∂r mig ({attendingChats.length})</h2>
                            {attendingChats.length > 0 ? (
                                <div className="space-y-4">
                                    {attendingChats.map(event => (
                                        <ChatEventCard key={event.eventID} event={event} />
                                    ))}
                                </div>
                            ) : (
                                <EmptyState title="Inga kommande chattar" text="G√• med i en tr√§ff f√∂r att se chatten h√§r."/>
                            )}
                        </div>
                        <div>
                            <h2 className="text-lg font-bold text-[#2E2E2E] text-center mb-3 underline">Mina skapade tr√§ffar ({createdChats.length})</h2>
                            {createdChats.length > 0 ? (
                                <div className="space-y-4">
                                    {createdChats.map(event => (
                                        <ChatEventCard key={event.eventID} event={event} />
                                    ))}
                                </div>
                            ) : (
                                <EmptyState title="Inga skapade chattar" text="Skapa en tr√§ff f√∂r att starta en chatt." />
                            )}
                        </div>
                    </main>
                </div>
            );
        });

        const ChatDetailScreen = memo(({ eventId, events, usersById, currentUser, chatMessages, onSendMessage, onBack }) => {
            const event = useMemo(() => events.find(e => e.eventID === eventId), [events, eventId]);

            if (!event) {
                useEffect(() => onBack(), [onBack]);
                return null;
            }
            
            const attendees = event.attendeeUserIDs.map(id => usersById[id]);

            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 flex items-center gap-4 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                         <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-100/60">
                            <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-lg font-bold text-[#2E2E2E] truncate">{event.title}</h1>
                    </header>
                    <main className="flex-grow flex flex-col p-4 space-y-4 overflow-hidden">
                        <p className="text-sm text-slate-500 break-words flex-shrink-0">{event.description}</p>
                        <div className="flex-shrink-0">
                             <div className="flex flex-wrap gap-2">
                                {attendees.map(attendee => attendee && (
                                    <div key={attendee.userID} className={`flex items-center gap-2 pr-3 py-1 bg-slate-100 text-[#2E2E2E] rounded-full text-sm`}>
                                        <div className="w-6 h-6 rounded-full bg-ecru flex items-center justify-center font-bold text-[#2E2E2E]/70 text-xs">
                                            {attendee.name.charAt(0)}
                                        </div>
                                        {attendee.name}
                                    </div>
                                ))}
                            </div>
                        </div>
                        <ChatComponent 
                            eventId={eventId} 
                            messages={chatMessages[eventId] || []} 
                            usersById={usersById} 
                            currentUser={currentUser} 
                            onSendMessage={onSendMessage} 
                            onBack={onBack}
                        />
                    </main>
                </div>
            )
        });
        
        function App() {
            const [viewStack, setViewStack] = useState([{ name: 'login', payload: null }]);
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState(USERS_DATA);
            const [events, setEvents] = useState(INITIAL_EVENTS_DATA);
            const [chatMessages, setChatMessages] = useState(INITIAL_CHAT_MESSAGES_DATA);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [modal, setModal] = useState({ show: false, title: '', message: '', buttons: [] });
            const [pendingEvent, setPendingEvent] = useState(null);
            const appContainerRef = useRef(null);

            const currentView = viewStack[viewStack.length - 1];

            const usersById = useMemo(() => 
                users.reduce((acc, user) => {
                    acc[user.userID] = user;
                    return acc;
                }, {}), 
            [users]);


            useEffect(() => {
                const appContainer = appContainerRef.current;
                if (!appContainer) return;
                const handleViewportResize = () => {
                    if (window.visualViewport) {
                        appContainer.style.height = `${window.visualViewport.height}px`;
                    }
                };
                handleViewportResize();
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', handleViewportResize);
                }
                return () => {
                    if (window.visualViewport) {
                        window.visualViewport.removeEventListener('resize', handleViewportResize);
                    }
                };
            }, []);

            useEffect(() => {
                if (toast.show) {
                    const timer = setTimeout(() => {
                        setToast({ show: false, message: '' });
                    }, 3000);
                    return () => clearTimeout(timer);
                }
            }, [toast]);

            const showToast = useCallback((message) => {
                setToast({ show: true, message });
            }, []);
            
            const showModal = useCallback(({ title, message, buttons = [{ label: 'OK' }] }) => {
                setModal({ show: true, title, message, buttons });
            }, []);

            const hideModal = useCallback(() => {
                setModal({ show: false, title: '', message: '', buttons: [] });
            }, []);

            const handleLogin = useCallback((user) => {
                setCurrentUser(user);
                setViewStack([{ name: 'home', payload: null }]);
            }, []);
            
            const handleLogout = useCallback(() => {
                setCurrentUser(null);
                setViewStack([{ name: 'login', payload: null }]);
            }, []);

            const handleNavigate = useCallback((viewName, payload = null) => {
                setViewStack(prevStack => [...prevStack, { name: viewName, payload }]);
            }, []);
            
            const handleTabNavigate = useCallback((viewName) => {
                 setViewStack([{ name: viewName, payload: null }]);
            }, []);

            const handleBack = useCallback(() => {
                setViewStack(prevStack => prevStack.length > 1 ? prevStack.slice(0, -1) : prevStack);
            }, []);
            
            const handleProceedToConfirm = useCallback((eventData) => {
                setPendingEvent(eventData);
                handleNavigate('confirm-event');
            }, [handleNavigate]);

            const handleCreateEvent = useCallback(() => {
                if (!pendingEvent) return;
                const newEvent = { ...pendingEvent, eventID: Date.now() };
                delete newEvent.formState; // Clean up form state before saving
                setEvents(prevEvents => [newEvent, ...prevEvents]);
                setPendingEvent(null);
                setViewStack([{ name: 'home', payload: null }]);
                showToast('Din tr√§ff har skapats!');
            }, [pendingEvent, showToast]);

            const handleEditPendingEvent = useCallback(() => {
                handleBack(); // Go back to the create screen
            }, [handleBack]);

             const handleUpdateEvent = useCallback((updatedEvent) => {
                setEvents(prevEvents => prevEvents.map(event => 
                    event.eventID === updatedEvent.eventID ? updatedEvent : event
                ));
                handleBack();
                showToast('Tr√§ffen har uppdaterats!');
            }, [handleBack, showToast]);

            const handleDeleteEvent = useCallback((eventId) => {
                setEvents(prevEvents => prevEvents.filter(event => event.eventID !== eventId));
                setViewStack([{ name: 'home', payload: null }]);
                showToast('Tr√§ffen har tagits bort.');
            }, [showToast]);
            
            const handleJoinEvent = useCallback((eventId) => {
                setEvents(prevEvents => prevEvents.map(event => {
                    if (event.eventID === eventId && !event.attendeeUserIDs.includes(currentUser.userID)) {
                        return { ...event, attendeeUserIDs: [...event.attendeeUserIDs, currentUser.userID] };
                    }
                    return event;
                }));
                showToast('Du √§r nu med i tr√§ffen!');
            }, [currentUser, showToast]);

            const handleLeaveEvent = useCallback((eventId) => {
                setEvents(prevEvents => prevEvents.map(event => {
                    if (event.eventID === eventId) {
                        return { ...event, attendeeUserIDs: event.attendeeUserIDs.filter(id => id !== currentUser.userID) };
                    }
                    return event;
                }));
                showToast('Du har l√§mnat tr√§ffen.');
            }, [currentUser, showToast]);

            const handleSignUp = useCallback((newUserData) => {
                const newUser = {
                    ...newUserData,
                    userID: Date.now(),
                };
                setUsers(prevUsers => [...prevUsers, newUser]);
                setCurrentUser(newUser);
                setViewStack([{ name: 'home', payload: null }]);
            }, []);

            const handleSendMessage = useCallback((eventId, text) => {
                const newMessage = {
                    messageID: Date.now(),
                    userID: currentUser.userID,
                    text: text,
                    timestamp: new Date().toISOString()
                };
                setChatMessages(prevMessages => ({
                    ...prevMessages,
                    [eventId]: [...(prevMessages[eventId] || []), newMessage]
                }));
            }, [currentUser]);

            const renderView = () => {
                if (!currentUser) {
                    switch(currentView.name) {
                        case 'signup':
                            return <SignUpScreen onSignUp={handleSignUp} onNavigate={handleNavigate} />;
                        default:
                            return <LoginScreen users={users} onLogin={handleLogin} onNavigate={handleNavigate} />;
                    }
                }
                
                let mainContent;
                switch (currentView.name) {
                    case 'details':
                        mainContent = <EventDetailsScreen 
                            eventId={currentView.payload} 
                            events={events} 
                            usersById={usersById} 
                            currentUser={currentUser} 
                            onJoin={handleJoinEvent} 
                            onLeave={handleLeaveEvent}
                            onNavigate={handleNavigate}
                            onBack={handleBack}
                            chatMessages={chatMessages}
                            onSendMessage={handleSendMessage}
                        />;
                        break;
                    case 'create':
                        mainContent = <CreateEventScreen 
                            currentUser={currentUser} 
                            onProceed={handleProceedToConfirm} 
                            onNavigate={handleNavigate} 
                            onBack={handleBack}
                            initialData={pendingEvent ? pendingEvent.formState : {}}
                            showModal={showModal}
                        />;
                        break;
                    case 'confirm-event':
                        mainContent = <ConfirmEventScreen 
                            eventData={pendingEvent}
                            onConfirm={handleCreateEvent}
                            onEdit={handleEditPendingEvent}
                            onBack={handleBack}
                        />;
                        break;
                    case 'edit-event':
                        mainContent = <EditEventScreen 
                            eventId={currentView.payload}
                            events={events}
                            onUpdate={handleUpdateEvent}
                            onDelete={handleDeleteEvent}
                            onNavigate={handleNavigate}
                            onBack={handleBack}
                            showModal={showModal}
                        />;
                        break;
                    case 'my-events':
                        mainContent = <MyEventsScreen events={events} currentUser={currentUser} onNavigate={handleNavigate} />;
                        break;
                    case 'chat':
                        mainContent = <ChatListScreen events={events} currentUser={currentUser} onNavigate={handleNavigate} usersById={usersById} />;
                        break;
                    case 'chat-detail':
                        mainContent = <ChatDetailScreen 
                            eventId={currentView.payload} 
                            events={events} 
                            usersById={usersById} 
                            currentUser={currentUser} 
                            chatMessages={chatMessages}
                            onSendMessage={handleSendMessage}
                            onBack={handleBack}
                        />;
                        break;
                    case 'profile':
                        mainContent = <ProfileScreen events={events} currentUser={currentUser} onLogout={handleLogout} onNavigate={handleNavigate} />;
                        break;
                    case 'event-history':
                        mainContent = <EventHistoryScreen events={events} currentUser={currentUser} usersById={usersById} onNavigate={handleNavigate} onBack={handleBack} />;
                        break;
                    default:
                        mainContent = <HomeScreen events={events} onNavigate={handleNavigate} currentUser={currentUser} />;
                }

                const showBottomNav = ['home', 'my-events', 'chat', 'profile'].includes(currentView.name);
                const activeNav = currentView.name === 'chat-detail' ? 'chat' : currentView.name;
                
                return (
                    <div className="h-full flex flex-col relative">
                        <div id="main-app-scroller" className="flex-grow overflow-y-auto">
                            <div key={viewStack.length} className="view-container-animate h-full">
                                {mainContent}
                            </div>
                        </div>
                        {['home', 'my-events'].includes(currentView.name) && (
                                 <button 
                                 onClick={() => handleNavigate('create')} 
                                 className="absolute bottom-24 right-6 w-14 h-14 rounded-full bg-salviagron text-white shadow-lg flex items-center justify-center hover:opacity-90 transition-transform active:scale-95 duration-150 border-[0.1mm] border-ecru"
                                >
                                    <Icons.plus className="w-8 h-8" />
                                </button>
                        )}
                        {showBottomNav && <BottomNav activeView={activeNav} onNavigate={handleTabNavigate} />}
                    </div>
                );
            };

            return (
                <div className="bg-slate-100 min-h-screen flex justify-center">
                    <div ref={appContainerRef} className="w-full max-w-sm bg-white shadow-lg flex flex-col" style={{ height: '100vh', maxHeight: '100vh', overflow: 'hidden' }}>
                        {renderView()}
                    </div>
                     <Toast message={toast.message} show={toast.show} />
                    <Modal
                        show={modal.show}
                        title={modal.title}
                        message={modal.message}
                        buttons={modal.buttons}
                        onClose={hideModal}
                    />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
"

